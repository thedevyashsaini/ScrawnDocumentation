---
title: Track Middleware Calls
description: Automatically track API requests with middleware
---

## Overview

The `middlewareEventConsumer` method creates Express-compatible middleware that automatically tracks usage for API requests. This is perfect for REST APIs where you want to charge per request without manually calling `sdkCallEventConsumer`.

<Callout type="warn">
**Framework Compatibility**: The middleware is designed for Express-like frameworks with standard `(req, res, next)` signatures. For frameworks like Fastify, Next.js, or Hono with different middleware patterns, you may need to manually call `sdkCallEventConsumer` in your route handlers or adapt the middleware with wrapper functions.
</Callout>

## How It Works

The middleware intercepts HTTP requests, extracts userId and debitAmount via your custom extractor function, and automatically tracks the usage event. It supports whitelist/blacklist patterns with wildcards for fine-grained control.

```typescript
import { Scrawn, type EventPayload } from '@scrawn/core';

const scrawn = new Scrawn({
  apiKey: process.env.SCRAWN_KEY as `scrn_${string}`,
  baseURL: process.env.SCRAWN_BASE_URL || 'http://localhost:8069',
});

// Middleware automatically tracks each request
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => ({
    userId: req.headers['x-user-id'] as string,
    debitAmount: req.body?.cost || 1,
  }),
}));
```

<Callout type="info">
**In simple terms:** When a request comes in, grab the `userId` from the request headers and the `debitAmount` from the request body, then charge that user that amount.
</Callout>

## Configuration

### `extractor` (required)
- **Type:** `(request) => EventPayload | Promise<EventPayload> | null | Promise<null>`
- **Description:** Function to extract userId and debitAmount from the request. Return `null` to skip tracking.
- **Returns:** [EventPayload](/docs/api-reference#eventpayload) object with `userId` (string) and `debitAmount` (number), or `null`

**Basic extractor:**
```typescript
extractor: (req) => ({
  userId: req.user.id,
  debitAmount: 10,
})
```

**Async extractor:**
```typescript
extractor: async (req) => {
  const user = await getUser(req);
  return { userId: user.id, debitAmount: calculateCost(req) };
}
```

**Skip tracking conditionally:**
```typescript
extractor: (req) => {
  if (!req.user) return null;
  return { userId: req.user.id, debitAmount: 1 };
}
```

### `whitelist` (optional)
- **Type:** `string[]`
- **Description:** Array of endpoint patterns to track. Takes precedence over blacklist.
- **Wildcards:** 
  - `*` matches a single path segment (e.g., `/api/*` matches `/api/users` but not `/api/users/123`)
  - `**` matches multiple segments (e.g., `/api/**` matches any path starting with `/api/`)

```typescript
whitelist: ['/api/generate', '/api/analyze', '/api/v1/*']
```

### `blacklist` (optional)
- **Type:** `string[]`
- **Description:** Array of endpoint patterns to exclude. Only applies to endpoints not in whitelist.
- **Wildcards:** Same as whitelist

```typescript
blacklist: ['/health', '/api/collect-payment', '/internal/**', '**.tmp']
```

## Framework Examples

### Express.js

```typescript
import express from 'express';
import { Scrawn, type EventPayload } from '@scrawn/core';

const app = express();
app.use(express.json());

const scrawn = new Scrawn({
  apiKey: process.env.SCRAWN_KEY as `scrn_${string}`,
  baseURL: process.env.SCRAWN_BASE_URL || 'http://localhost:8069',
});

// Apply middleware to all routes
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => ({
    userId: req.headers['x-user-id'] as string,
    debitAmount: req.body?.cost || 1,
  }),
  blacklist: ['/health', '/api/collect-payment'],
}));

// Or apply to specific routes only
app.use('/api/premium', scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => ({
    userId: req.user?.id || 'anonymous',
    debitAmount: 50,
  }),
}));
```

### Fastify

Fastify uses a different hook system, so we need to wrap the Express-compatible middleware manually:

```typescript
import Fastify from 'fastify';
import { Scrawn, type EventPayload } from '@scrawn/core';

const fastify = Fastify();
const scrawn = new Scrawn({
  apiKey: process.env.SCRAWN_KEY as `scrn_${string}`,
  baseURL: process.env.SCRAWN_BASE_URL || 'http://localhost:8069',
});

// Wrap the middleware for Fastify's preHandler hook
fastify.addHook('preHandler', async (request, reply) => {
  const middleware = scrawn.middlewareEventConsumer({
    extractor: (req): EventPayload => ({
      userId: (req as any).user?.id || 'anonymous',
      debitAmount: 10,
    }),
  });
  
  await new Promise<void>((resolve, reject) => {
    middleware(request as any, reply as any, (err) => {
      if (err) reject(err);
      else resolve();
    });
  });
});
```

### Next.js Middleware

<Callout type="warn">
**Next.js Compatibility**: Next.js middleware doesn't support the standard Express `(req, res, next)` signature. You'll need to use [`sdkCallEventConsumer`](/docs/scrawn-js/sdk-call-event) directly instead of `middlewareEventConsumer`.
</Callout>

Use `sdkCallEventConsumer` directly in Next.js middleware:

```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { Scrawn } from '@scrawn/core';

const scrawn = new Scrawn({
  apiKey: process.env.SCRAWN_KEY as `scrn_${string}`,
  baseURL: process.env.SCRAWN_BASE_URL || 'http://localhost:8069',
});

export async function middleware(request: NextRequest) {
  if (request.nextUrl.pathname.startsWith('/api')) {
    await scrawn.sdkCallEventConsumer({
      userId: request.headers.get('x-user-id') || 'anonymous',
      debitAmount: 10,
    });
  }
  
  return NextResponse.next();
}

export const config = {
  matcher: '/api/:path*',
};
```

## Advanced Patterns

### Dynamic Pricing Based on Endpoint

```typescript
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => {
    const endpoint = req.path || req.url || '';
    
    let debitAmount = 1;
    if (endpoint.startsWith('/api/ai')) debitAmount = 100;
    else if (endpoint.startsWith('/api/premium')) debitAmount = 50;
    else if (endpoint.startsWith('/api/standard')) debitAmount = 10;
    
    return {
      userId: req.headers['x-user-id'] as string,
      debitAmount,
    };
  },
}));
```

### Conditional Tracking with Extractor

```typescript
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload | null => {
    // Skip tracking for non-authenticated requests
    if (!req.user) {
      return null;
    }
    
    // Skip tracking for admin users
    if (req.user.role === 'admin') {
      return null;
    }
    
    return {
      userId: req.user.id,
      debitAmount: 10,
    };
  },
}));
```

### Whitelist/Blacklist Patterns

```typescript
// Only track specific endpoints
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => ({
    userId: req.user.id,
    debitAmount: 10,
  }),
  whitelist: [
    '/api/generate',
    '/api/analyze',
    '/api/v1/*',        // Single segment wildcard
    '/api/premium/**',  // Multi-segment wildcard
  ],
}));

// Exclude specific endpoints
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => ({
    userId: req.user.id,
    debitAmount: 10,
  }),
  blacklist: [
    '/health',
    '/api/collect-payment',
    '/internal/**',     // Exclude all internal routes
    '**.tmp',           // Exclude temp file requests
  ],
}));
```

### Request Size-Based Pricing

```typescript
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => {
    const sizeInKB = parseInt(req.headers['content-length'] || '0', 10) / 1024;
    const basePrice = 10;
    const sizePrice = Math.ceil(sizeInKB) * 5;
    
    return {
      userId: req.user.id,
      debitAmount: basePrice + sizePrice,
    };
  },
}));
```

## Error Handling

### Automatic Error Handling

The middleware automatically catches and logs errors without blocking requests:

```typescript
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => ({
    userId: req.user.id,
    debitAmount: 10,
  }),
}));
```

### Explicit Error Handling

To handle errors explicitly and potentially block requests, use `sdkCallEventConsumer` directly:

```typescript
app.use(async (req, res, next) => {
  try {
    await scrawn.sdkCallEventConsumer({
      userId: req.user.id,
      debitAmount: 10,
    });
    next();
  } catch (error) {
    console.error('Failed to track usage:', error);
    // Decide whether to block the request
    res.status(500).json({ error: 'Failed to track usage' });
  }
});
```

## Best Practices

### 1. Place Middleware After Authentication
```typescript
// ✅ Good - User info is available
app.use(authMiddleware);
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => ({
    userId: req.user.id,
    debitAmount: 10,
  }),
}));

// ❌ Bad - Won't have user info
app.use(scrawn.middlewareEventConsumer({ /* ... */ }));
app.use(authMiddleware);
```

### 2. Use Blacklist for Internal Routes
```typescript
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => ({
    userId: req.user.id,
    debitAmount: 10,
  }),
  blacklist: ['/internal/**', '/health', '/_next/**'],
}));
```

### 3. Return Null for Invalid Requests
```typescript
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload | null => {
    if (!req.user) {
      // Skip tracking for unauthenticated requests
      return null;
    }
    return {
      userId: req.user.id,
      debitAmount: 10,
    };
  },
}));
```

### 4. Don't Await Events Inline
The middleware automatically handles async tracking without blocking. Event tracking runs in the background while your handler executes.

```typescript title="app.ts"
app.use(scrawn.middlewareEventConsumer({
  extractor: (req): EventPayload => ({
    userId: req.user.id,
    debitAmount: 10,
  }),
}));

app.post('/api/generate', async (req, res) => {
  // Your handler runs immediately - tracking happens in parallel
  const result = await generateContent(req.body);
  res.json({ result });
});
```

## Next Steps

<Cards>
  <Card href="/docs/scrawn-js/advanced-usage" title="Advanced Usage">
    Some advanced usage patterns
  </Card>
  <Card href="/docs/scrawn-js/framework-integration" title="Framework Integration">
    Integration examples for popular frameworks
  </Card>
</Cards>
